---
- name: "Install DRBD"
  hosts: all
  order: sorted
  become: yes
  tasks:
#    - name: Add repository Elrepo 8
#      ansible.builtin.yum_repository:
#        name: elrepo_8
#        description: ELREPO YUM repo 
#        baseurl: https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm
#        when: ansible_distribution_major_version = 8
    
    - name: Add repository Elrepo 9
      ansible.builtin.dnf:
        name: elrepo-release
        state: latest
 #       when: ansible_distribution_major_version = 9

    - name: Install DRBD module
      ansible.builtin.dnf:
        name: kmod-drbd9x
        state: latest

    - name: Install DRBD package
      ansible.builtin.dnf:
        name: drbd9x-utils
        state: latest

    - name: Copy global common conf
      ansible.builtin.copy:
        src: files/global_common.conf
        dest: /etc/drbd.d/global_common.conf
        owner: root
        group: root
        mode: '0600'

    - name: Copy r0
      ansible.builtin.copy:
        src: files/r0.res
        dest: /etc/drbd.d/r0.res
        owner: root
        group: root
        mode: '0600'

    - name: Create ressource DRBD
      ansible.builtin.command: drbdadm create r0
 
    - name: Initialize ressource DRBD
      ansible.builtin.command: drbdadm up r0

    - name: Make one node primary
      ansible.builtin.command: drbdadm primary --force r0

    - name: check status
      ansible.builtin.command: drbdadm status
